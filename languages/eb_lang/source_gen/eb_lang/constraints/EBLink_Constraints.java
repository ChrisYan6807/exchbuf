package eb_lang.constraints;

/*Generated by MPS */

import jetbrains.mps.smodel.runtime.base.BaseConstraintsDescriptor;
import java.util.Map;
import org.jetbrains.mps.openapi.language.SReferenceLink;
import jetbrains.mps.smodel.runtime.ReferenceConstraintsDescriptor;
import jetbrains.mps.smodel.runtime.base.BaseReferenceConstraintsDescriptor;
import org.jetbrains.annotations.Nullable;
import jetbrains.mps.smodel.runtime.ReferenceScopeProvider;
import jetbrains.mps.smodel.runtime.base.BaseScopeProvider;
import org.jetbrains.mps.openapi.model.SNodeReference;
import jetbrains.mps.smodel.SNodePointer;
import jetbrains.mps.scope.Scope;
import jetbrains.mps.smodel.runtime.ReferenceConstraintsContext;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import java.util.List;
import org.jetbrains.mps.openapi.model.SNode;
import java.util.ArrayList;
import jetbrains.mps.internal.collections.runtime.Sequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.SetSequence;
import java.util.HashSet;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.scope.ListScope;
import java.util.HashMap;
import org.jetbrains.mps.openapi.language.SConcept;
import jetbrains.mps.smodel.adapter.structure.MetaAdapterFactory;
import org.jetbrains.mps.openapi.language.SContainmentLink;

public class EBLink_Constraints extends BaseConstraintsDescriptor {
  public EBLink_Constraints() {
    super(CONCEPTS.EBLink$1X);
  }

  @Override
  protected Map<SReferenceLink, ReferenceConstraintsDescriptor> getSpecifiedReferences() {
    BaseReferenceConstraintsDescriptor d0 = new BaseReferenceConstraintsDescriptor(LINKS.base$F2Ny, this, true, false) {
      @Nullable
      @Override
      public ReferenceScopeProvider getScopeProvider() {
        return new BaseScopeProvider() {
          @Override
          public SNodeReference getSearchScopeValidatorNode() {
            return new SNodePointer("r:3627401c-d045-43be-a0d6-b80453db7eba(eb_lang.constraints)", "1399011618608978073");
          }
          @Override
          public Scope createScope(final ReferenceConstraintsContext _context) {
            final int idx = SNodeOperations.getIndexInParent(SNodeOperations.getNodeAncestor(_context.getContextNode(), CONCEPTS.EBLink$1X, true, false));
            List<SNode> msgs_list = new ArrayList<SNode>();
            Iterable<SNode> msgs = Sequence.fromIterable(SNodeOperations.ofConcept(SLinkOperations.getChildren(SNodeOperations.getNodeAncestor(_context.getContextNode(), CONCEPTS.EBProtocol$zC, true, false), LINKS.statements$_5KW), CONCEPTS.EBMessage$YV)).where((it) -> SNodeOperations.getIndexInParent(it) < idx);

            Set<SNode> msg_set = SetSequence.fromSet(new HashSet<SNode>());
            for (SNode msg : msgs) {
              if ((SLinkOperations.getTarget(msg, LINKS.base$LfNH) != null) && !(SetSequence.fromSet(msg_set).contains(SLinkOperations.getTarget(msg, LINKS.base$LfNH)))) {
                ListSequence.fromList(msgs_list).addElement(SLinkOperations.getTarget(msg, LINKS.base$LfNH));
                SetSequence.fromSet(msg_set).addElement(SLinkOperations.getTarget(msg, LINKS.base$LfNH));
              }
            }

            return ListScope.forNamedElements(msgs_list);
          }
        };
      }
    };
    BaseReferenceConstraintsDescriptor d1 = new BaseReferenceConstraintsDescriptor(LINKS.derived$F3h$, this, true, false) {
      @Nullable
      @Override
      public ReferenceScopeProvider getScopeProvider() {
        return new BaseScopeProvider() {
          @Override
          public SNodeReference getSearchScopeValidatorNode() {
            return new SNodePointer("r:3627401c-d045-43be-a0d6-b80453db7eba(eb_lang.constraints)", "1399011618611312331");
          }
          @Override
          public Scope createScope(final ReferenceConstraintsContext _context) {
            SNode base = SLinkOperations.getTarget(SNodeOperations.cast(_context.getContextNode(), CONCEPTS.EBLink$1X), LINKS.base$F2Ny);
            // no base
            if ((base == null)) {
              return ListScope.forNamedElements(new ArrayList<SNode>());
            }

            final int idx = SNodeOperations.getIndexInParent(SNodeOperations.getNodeAncestor(_context.getContextNode(), CONCEPTS.EBLink$1X, true, false));
            List<SNode> msgs_list = new ArrayList<SNode>();
            Iterable<SNode> msgs = Sequence.fromIterable(SNodeOperations.ofConcept(SLinkOperations.getChildren(SNodeOperations.getNodeAncestor(_context.getContextNode(), CONCEPTS.EBProtocol$zC, true, false), LINKS.statements$_5KW), CONCEPTS.EBMessage$YV)).where((it) -> SNodeOperations.getIndexInParent(it) < idx);

            Iterable<SNode> defined_links = Sequence.fromIterable(SNodeOperations.ofConcept(SLinkOperations.getChildren(SNodeOperations.getNodeAncestor(_context.getContextNode(), CONCEPTS.EBProtocol$zC, true, false), LINKS.statements$_5KW), CONCEPTS.EBLink$1X)).where((it) -> SNodeOperations.getIndexInParent(it) < idx);

            Set<SNode> linked_msgs = SetSequence.fromSet(new HashSet<SNode>());
            for (SNode link : defined_links) {
              if ((SLinkOperations.getTarget(link, LINKS.derived$F3h$) != null)) {
                SetSequence.fromSet(linked_msgs).addElement(SLinkOperations.getTarget(link, LINKS.derived$F3h$));
              }
            }

            for (SNode msg : msgs) {
              if (SetSequence.fromSet(linked_msgs).contains(msg)) {
                continue;
              }
              if (SLinkOperations.getTarget(msg, LINKS.base$LfNH) == base) {
                ListSequence.fromList(msgs_list).addElement(msg);
              }
            }

            return ListScope.forNamedElements(msgs_list);
          }
        };
      }
    };
    BaseReferenceConstraintsDescriptor d2 = new BaseReferenceConstraintsDescriptor(LINKS.base_member$uj3_, this, true, false) {
      @Nullable
      @Override
      public ReferenceScopeProvider getScopeProvider() {
        return new BaseScopeProvider() {
          @Override
          public SNodeReference getSearchScopeValidatorNode() {
            return new SNodePointer("r:3627401c-d045-43be-a0d6-b80453db7eba(eb_lang.constraints)", "1399011618616628984");
          }
          @Override
          public Scope createScope(final ReferenceConstraintsContext _context) {
            return ListScope.forNamedElements(SLinkOperations.getChildren(SLinkOperations.getTarget(SNodeOperations.cast(_context.getContextNode(), CONCEPTS.EBLink$1X), LINKS.base$F2Ny), LINKS.content$vVwC));
          }
        };
      }
    };
    Map<SReferenceLink, ReferenceConstraintsDescriptor> references = new HashMap<SReferenceLink, ReferenceConstraintsDescriptor>();
    references.put(d0.getReference(), d0);
    references.put(d1.getReference(), d1);
    references.put(d2.getReference(), d2);
    return references;
  }

  private static final class CONCEPTS {
    /*package*/ static final SConcept EBLink$1X = MetaAdapterFactory.getConcept(0x59242254602f42f3L, 0xab3adc203eb4cc03L, 0x136a49a7a3b2413fL, "eb_lang.structure.EBLink");
    /*package*/ static final SConcept EBProtocol$zC = MetaAdapterFactory.getConcept(0x59242254602f42f3L, 0xab3adc203eb4cc03L, 0x726a4e86e23f3cf6L, "eb_lang.structure.EBProtocol");
    /*package*/ static final SConcept EBMessage$YV = MetaAdapterFactory.getConcept(0x59242254602f42f3L, 0xab3adc203eb4cc03L, 0x726a4e86e2416a26L, "eb_lang.structure.EBMessage");
  }

  private static final class LINKS {
    /*package*/ static final SReferenceLink base$F2Ny = MetaAdapterFactory.getReferenceLink(0x59242254602f42f3L, 0xab3adc203eb4cc03L, 0x136a49a7a3b2413fL, 0x136a49a7a3d4e29cL, "base");
    /*package*/ static final SContainmentLink statements$_5KW = MetaAdapterFactory.getContainmentLink(0x59242254602f42f3L, 0xab3adc203eb4cc03L, 0x726a4e86e23f3cf6L, 0x726a4e86e23f3cfcL, "statements");
    /*package*/ static final SReferenceLink base$LfNH = MetaAdapterFactory.getReferenceLink(0x59242254602f42f3L, 0xab3adc203eb4cc03L, 0x726a4e86e2416a26L, 0x1fd2ea8cbdac6546L, "base");
    /*package*/ static final SReferenceLink derived$F3h$ = MetaAdapterFactory.getReferenceLink(0x59242254602f42f3L, 0xab3adc203eb4cc03L, 0x136a49a7a3b2413fL, 0x136a49a7a3d4e29eL, "derived");
    /*package*/ static final SReferenceLink base_member$uj3_ = MetaAdapterFactory.getReferenceLink(0x59242254602f42f3L, 0xab3adc203eb4cc03L, 0x136a49a7a3b2413fL, 0x136a49a7a448bb39L, "base_member");
    /*package*/ static final SContainmentLink content$vVwC = MetaAdapterFactory.getContainmentLink(0x59242254602f42f3L, 0xab3adc203eb4cc03L, 0x726a4e86e2416a26L, 0x7b5896debde675baL, "content");
  }
}
